!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.TappyType4Family=e()}(this,function(){function o(t,e){for(var r=[],o=0;o<e.length;o++){var n=e[o];"function"!=typeof t[n]&&r.push(n)}return r}function r(t,e){var r=o(t,e);return!(null===r||0<r.length)}function n(t,r){return t.length==r.length&&t.every(function(t,e){return t===r[e]})}function t(e){return function(t){if("object"!=typeof t||null===t)throw new Error("Command passed to check type must be an object implementing: "+a.join(", "));if(r(t,a))return n(t.getCommandFamily(),s)&&t.getCommandCode()===e;throw new Error("Command passed to check type must also implement: "+o(t,a).join(", "))}}function e(t){return{getCommandFamily:function(){return s},getCommandCode:function(){return t},getPayload:function(){return[]},parsePayload:function(){}}}function i(t){this.timeout=void 0===t?0:t}var s=new Uint8Array([0,4]),a=["getCommandFamily","getCommandCode","getPayload"],p={},y=2,u=3,c=4,d=1,h=255;(i.prototype=e(u)).getTimeout=function(){return this.timeout},i.prototype.setTimeout=function(t){this.timeout=t},i.prototype.parsePayload=function(t){if(t.length<1)throw new Error("Invalid payload: must be at least one byte");this.timeout=t[0]},i.prototype.getPayload=function(){return new Uint8Array([this.timeout])},i.isTypeOf=t(u),p.DetectType4B=i;function l(t,e){this.timeout=void 0===t?0:t,this.afi=void 0===e?0:e}(l.prototype=e(c)).getTimeout=function(){return this.timeout},l.prototype.setTimeout=function(t){this.timeout=t},l.prototype.getAfi=function(){return this.afi},l.prototype.setAfi=function(t){this.afi=t},l.prototype.parsePayload=function(t){if(t.length<2)throw new Error("Invalid payload: must be at least two bytes");this.timeout=t[0],this.afi=t[1]},l.prototype.getPayload=function(){return new Uint8Array([this.timeout,this.afi])},l.isTypeOf=t(c),p.DetectType4BSpecificAfi=l;function f(t){this.timeout=void 0===t?0:t}(f.prototype=e(d)).getTimeout=function(){return this.timeout},f.prototype.setTimeout=function(t){this.timeout=t},f.prototype.parsePayload=function(t){if(t.length<1)throw new Error("Invalid payload: must be at least one byte");this.timeout=t[0]},f.prototype.getPayload=function(){return new Uint8Array([this.timeout])},f.isTypeOf=t(d),p.DetectType4=f;function m(){}m.prototype=e(h),m.isTypeOf=t(h),p.GetLibraryVersion=m;function T(t){this.apdu=void 0===t?new Uint8Array(0):t}(T.prototype=e(y)).getApdu=function(){return this.apdu},T.prototype.setApdu=function(t){this.apdu=t},T.prototype.parsePayload=function(t){this.apdu=t},T.prototype.getPayload=function(){return this.apdu},T.isTypeOf=t(y),p.TransceiveApdu=T;var g={},b=2,E=7,A=1,w=5,v=4,C=3,P=127;g.ApduTransceiveSuccessful=function(t){this.apdu=void 0===t?new Uint8Array(0):t},g.ApduTransceiveSuccessful.prototype=e(b),g.ApduTransceiveSuccessful.isTypeOf=t(b),g.ApduTransceiveSuccessful.prototype.getPayload=function(){return this.apdu},g.ApduTransceiveSuccessful.prototype.parsePayload=function(t){this.apdu=t},g.ApduTransceiveSuccessful.prototype.getApdu=function(){return this.apdu},g.ApduTransceiveSuccessful.prototype.setApdu=function(t){this.apdu=t},g.Type4BDetected=function(t,e){this.atqb=void 0===t?new Uint8Array(0):t,this.attrib=void 0===e?new Uint8Array(0):e},g.Type4BDetected.prototype=e(E),g.Type4BDetected.isTypeOf=t(E),g.Type4BDetected.prototype.getPayload=function(){var t=new Uint8Array(this.atqb.length+this.attrib.length+2);return t[0]=this.atqb.length,t[1]=this.attrib.length,0<this.atqb.length&&t.set(this.atqb,2),0<this.attrib.length&&t.set(this.attrib,2+this.atqb.length),t},g.Type4BDetected.prototype.parsePayload=function(t){if(t.length<2)throw new Error("Payload must be at least 2 bytes");var e=t[0],r=t[1];if(t.length<2+e+r)throw new Error("Payload too short to contain specified ATQB and ATTRIB");this.atqb=0<e?t.slice(2,2+e):new Uint8Array(0),this.attrib=0<r?t.slice(2+e,2+e+r):new Uint8Array(0)},g.Type4BDetected.prototype.getAtqb=function(){return this.atqb},g.Type4BDetected.prototype.setAtqb=function(t){this.atqb=t},g.Type4BDetected.prototype.getAttrib=function(){return this.attrib},g.Type4BDetected.prototype.setAttrib=function(t){this.attrib=t},g.Type4Detected=function(t,e){this.uid=void 0===t?new Uint8Array(0):t,this.ats=void 0===e?new Uint8Array(0):e},g.Type4Detected.prototype=e(A),g.Type4Detected.isTypeOf=t(A),g.Type4Detected.prototype.getPayload=function(){var t=new Uint8Array(1+this.uid.length+this.ats.length);return t[0]=this.uid.length,t.set(this.uid,1),t.set(this.ats,1+this.uid.length),t},g.Type4Detected.prototype.parsePayload=function(t){if(t.length<1)throw new Error("Payload must be at least one byte");var e=t[0];this.uid=t.slice(1,1+e),t.length>1+e?this.ats=t.slice(1+e):this.ats=new Uint8Array(0)},g.Type4Detected.prototype.getUid=function(){return this.uid},g.Type4Detected.prototype.setUid=function(t){this.uid=t},g.Type4Detected.prototype.getAts=function(){return this.ats},g.Type4Detected.prototype.setAts=function(t){this.ats=t},g.Type4PollingError=function(){},g.Type4PollingError.prototype=e(v),g.Type4PollingError.isTypeOf=t(v),g.Type4Timeout=function(){},g.Type4Timeout.prototype=e(C),g.Type4Timeout.isTypeOf=t(C),g.Type4LibraryVersion=function(){arguments.length<2?(this.majorVersion=0,this.minorVersion=0):(this.majorVersion=arguments[0],this.minorVersion=arguments[1])},g.Type4LibraryVersion.prototype=e(w),g.Type4LibraryVersion.isTypeOf=t(w),g.Type4LibraryVersion.prototype.getPayload=function(){return new Uint8Array([this.majorVersion,this.minorVersion])},g.Type4LibraryVersion.prototype.parsePayload=function(t){if(t.length<2)throw new Error("Type4Library version responses must be at least 2 bytes");this.majorVersion=t[0],this.minorVersion=t[1]},g.Type4LibraryVersion.prototype.getMajorVersion=function(){return this.majorVersion},g.Type4LibraryVersion.prototype.getMinorVersion=function(){return this.minorVersion},g.Type4LibraryVersion.prototype.setMajorVersion=function(t){this.majorVersion=t},g.Type4LibraryVersion.prototype.setMinorVersion=function(t){this.minorVersion=t},g.Type4Error=function(){arguments.length<3?(this.errorCode=0,this.internalErrorCode=0,this.readerStatus=0,this.message=""):(this.errorCode=arguments[0],this.internalErrorCode=arguments[1],this.readerStatus=arguments[2],this.message=3<arguments.length?arguments[3]:"")},g.Type4Error.isTypeOf=t(P),g.Type4Error.prototype=e(P),g.Type4Error.prototype.getPayload=function(){for(var t=unescape(encodeURIComponent(this.message)),e=[],r=0;r<t.length;r++)e.push(t.charCodeAt(r));var o=new Uint8Array(3+e.length);return o[0]=this.errorCode,o[1]=this.internalErrorCode,o[2]=this.readerStatus,o.set(e,3),o},g.Type4Error.prototype.parsePayload=function(t){if(t.length<3)throw new Error("Typer 4 error payload must be at least 3 bytes");this.errorCode=t[0],this.internalErrorCode=t[1],this.readerStatus=t[2],3<t.length?this.message=String.fromCharCode.apply(null,t.slice(3)):this.message=""},g.Type4Error.prototype.getErrorCode=function(){return this.errorCode},g.Type4Error.prototype.getInternalErrorCode=function(){return this.internalErrorCode},g.Type4Error.prototype.getReaderStatusCode=function(){return this.readerStatus},g.Type4Error.prototype.getErrorMessage=function(){return this.message},g.Type4Error.prototype.setErrorCode=function(t){this.errorCode=t},g.Type4Error.prototype.setInternalErrorCode=function(t){this.internalErrorCode=t},g.Type4Error.prototype.setReaderStatusCode=function(t){this.readerStatus=t},g.Type4Error.prototype.setErrorMessage=function(t){this.message=t};function V(t){if("object"!=typeof t||null===t)throw new Error("Command passed to resolver must be an object implementing: "+a.join(", "));if(!r(t,a))throw new Error("Error, command passed to resolver must also implement: "+o(t,a).join(", "));return!!n(t.getCommandFamily(),s)}function D(){}return D.prototype.checkFamily=V,D.prototype.validate=function(t){if(V(t))return!0;throw new Error("Resolver doesn't support command's family")},D.prototype.resolveCommand=function(t){var e=null;if(this.validate(t))switch(t.getCommandCode()){case y:(e=new p.TransceiveApdu).parsePayload(t.getPayload());break;case u:(e=new p.DetectType4B).parsePayload(t.getPayload());break;case c:(e=new p.DetectType4BSpecificAfi).parsePayload(t.getPayload());break;case d:(e=new p.DetectType4).parsePayload(t.getPayload());break;case h:(e=new p.GetLibraryVersion).parsePayload(t.getPayload())}return e},D.prototype.resolveResponse=function(t){var e=null;if(this.validate(t)){var r=null;switch(t.getCommandCode()){case b:r=g.ApduTransceiveSuccessful;break;case E:r=g.Type4BDetected;break;case A:r=g.Type4Detected;break;case w:r=g.Type4LibraryVersion;break;case v:r=g.Type4PollingError;break;case C:r=g.Type4Timeout;break;case P:r=g.Type4Error}null!==r&&(e=new r).parsePayload(t.getPayload())}return e},{Commands:p,Responses:g,ErrorCodes:{TOO_FEW_PARAMTERS:1,TOO_MANY_PARAMETERS:2,TRANSCEIVE_ERROR:3,INVALID_PARAMETER:4,NO_TAG_PRESENT:5,NFC_CHIP_ERROR:6},Resolver:D,FamilyCode:s}});