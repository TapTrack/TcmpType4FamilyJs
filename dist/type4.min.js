!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.TappyType4Family=t()}(this,function(){var e=new Uint8Array([0,4]),t=function(e,t){for(var r=[],o=0;o<t.length;o++){var i=t[o];"function"!=typeof e[i]&&r.push(i)}return r},r=function(e,r){var o=t(e,r);return!(null===o||o.length>0)},o=function(e,t){return e.length==t.length&&e.every(function(e,r){return e===t[r]})},i=["getCommandFamily","getCommandCode","getPayload"],n={},s={TransceiveApdu:2,DetectType4B:3,DetectType4BSpecificAfi:4,DetectType4:1,GetLibraryVersion:255},a=function(n){return function(s){if("object"!=typeof s||null===s)throw new Error("Command passed to check type must be an object implementing: "+i.join(", "));if(r(s,i))return o(s.getCommandFamily(),e)&&s.getCommandCode()===n;throw new Error("Command passed to check type must also implement: "+t(s,i).join(", "))}},p=function(t){return{getCommandFamily:function(){return e},getCommandCode:function(){return t},getPayload:function(){return[]},parsePayload:function(){}}},y=function(e){"undefined"==typeof e?this.timeout=0:this.timeout=e};y.prototype=p(s.DetectType4B),y.prototype.getTimeout=function(){return this.timeout},y.prototype.setTimeout=function(e){this.timeout=e},y.prototype.parsePayload=function(e){if(e.length<1)throw new Error("Invalid payload: must be at least one byte");this.timeout=e[0]},y.prototype.getPayload=function(){return new Uint8Array([this.timeout])},y.isTypeOf=a(s.DetectType4B),n.DetectType4B=y;var u=function(e,t){"undefined"==typeof e?this.timeout=0:this.timeout=e,"undefined"==typeof t?this.afi=0:this.afi=t};u.prototype=p(s.DetectType4BSpecificAfi),u.prototype.getTimeout=function(){return this.timeout},u.prototype.setTimeout=function(e){this.timeout=e},u.prototype.getAfi=function(){return this.afi},u.prototype.setAfi=function(e){this.afi=e},u.prototype.parsePayload=function(e){if(e.length<2)throw new Error("Invalid payload: must be at least two bytes");this.timeout=e[0],this.afi=e[1]},u.prototype.getPayload=function(){return new Uint8Array([this.timeout,this.afi])},u.isTypeOf=a(s.DetectType4BSpecificAfi),n.DetectType4BSpecificAfi=u;var c=function(e){"undefined"==typeof e?this.timeout=0:this.timeout=e};c.prototype=p(s.DetectType4),c.prototype.getTimeout=function(){return this.timeout},c.prototype.setTimeout=function(e){this.timeout=e},c.prototype.parsePayload=function(e){if(e.length<1)throw new Error("Invalid payload: must be at least one byte");this.timeout=e[0]},c.prototype.getPayload=function(){return new Uint8Array([this.timeout])},c.isTypeOf=a(s.DetectType4),n.DetectType4=c;var d=function(){};d.prototype=p(s.GetLibraryVersion),d.isTypeOf=a(s.GetLibraryVersion),n.GetLibraryVersion=d;var f=function(e){"undefined"==typeof e?this.apdu=new Uint8Array(0):this.apdu=e};f.prototype=p(s.TransceiveApdu),f.prototype.getApdu=function(){return this.apdu},f.prototype.setApdu=function(e){this.apdu=e},f.prototype.parsePayload=function(e){this.apdu=e},f.prototype.getPayload=function(){return this.apdu},f.isTypeOf=a(s.TransceiveApdu),n.TransceiveApdu=f;var h={},l={ApduTransceiveSuccessful:2,Type4BDetected:7,Type4Detected:1,Type4LibraryVersion:5,Type4PollingError:4,Type4Timeout:3,Type4Error:127};h.ApduTransceiveSuccessful=function(e){"undefined"==typeof e?this.apdu=new Uint8Array(0):this.apdu=e},h.ApduTransceiveSuccessful.prototype=p(l.ApduTransceiveSuccessful),h.ApduTransceiveSuccessful.isTypeOf=a(l.ApduTransceiveSuccessful),h.ApduTransceiveSuccessful.prototype.getPayload=function(){return this.apdu},h.ApduTransceiveSuccessful.prototype.parsePayload=function(e){this.apdu=e},h.ApduTransceiveSuccessful.prototype.getApdu=function(){return this.apdu},h.ApduTransceiveSuccessful.prototype.setApdu=function(e){this.apdu=e},h.Type4BDetected=function(e,t){"undefined"==typeof e?this.atqb=new Uint8Array(0):this.atqb=e,"undefined"==typeof t?this.attrib=new Uint8Array(0):this.attrib=t},h.Type4BDetected.prototype=p(l.Type4BDetected),h.Type4BDetected.isTypeOf=a(l.Type4BDetected),h.Type4BDetected.prototype.getPayload=function(){var e=new Uint8Array(this.atqb.length+this.attrib.length+2);return e[0]=this.atqb.length,e[1]=this.attrib.length,this.atqb.length>0&&e.set(this.atqb,2),this.attrib.length>0&&e.set(this.attrib,2+this.atqb.length),e},h.Type4BDetected.prototype.parsePayload=function(e){if(e.length<2)throw new Error("Payload must be at least 2 bytes");var t=e[0],r=e[1];if(e.length<2+t+r)throw new Error("Payload too short to contain specified ATQB and ATTRIB");t>0?this.atqb=e.slice(2,2+t):this.atqb=new Uint8Array(0),r>0?this.attrib=e.slice(2+t,2+t+r):this.attrib=new Uint8Array(0)},h.Type4BDetected.prototype.getAtqb=function(){return this.atqb},h.Type4BDetected.prototype.setAtqb=function(e){this.atqb=e},h.Type4BDetected.prototype.getAttrib=function(){return this.attrib},h.Type4BDetected.prototype.setAttrib=function(e){this.attrib=e},h.Type4Detected=function(e,t){"undefined"==typeof e?this.uid=new Uint8Array(0):this.uid=e,"undefined"==typeof t?this.ats=new Uint8Array(0):this.ats=t},h.Type4Detected.prototype=p(l.Type4Detected),h.Type4Detected.isTypeOf=a(l.Type4Detected),h.Type4Detected.prototype.getPayload=function(){var e=new Uint8Array(1+this.uid.length+this.ats.length);return e[0]=this.uid.length,e.set(this.uid,1),e.set(this.ats,1+this.uid.length),e},h.Type4Detected.prototype.parsePayload=function(e){if(e.length<1)throw new Error("Payload must be at least one byte");var t=e[0];this.uid=e.slice(1,1+t),e.length>1+t?this.ats=e.slice(1+t):this.ats=new Uint8Array(0)},h.Type4Detected.prototype.getUid=function(){return this.uid},h.Type4Detected.prototype.setUid=function(e){this.uid=e},h.Type4Detected.prototype.getAts=function(){return this.ats},h.Type4Detected.prototype.setAts=function(e){this.ats=e},h.Type4PollingError=function(){},h.Type4PollingError.prototype=p(l.Type4PollingError),h.Type4PollingError.isTypeOf=a(l.Type4PollingError),h.Type4Timeout=function(){},h.Type4Timeout.prototype=p(l.Type4Timeout),h.Type4Timeout.isTypeOf=a(l.Type4Timeout),h.Type4LibraryVersion=function(){arguments.length<2?(this.majorVersion=0,this.minorVersion=0):(this.majorVersion=arguments[0],this.minorVersion=arguments[1])},h.Type4LibraryVersion.prototype=p(l.Type4LibraryVersion),h.Type4LibraryVersion.isTypeOf=a(l.Type4LibraryVersion),h.Type4LibraryVersion.prototype.getPayload=function(){return new Uint8Array([this.majorVersion,this.minorVersion])},h.Type4LibraryVersion.prototype.parsePayload=function(e){if(e.length<2)throw new Error("Type4Library version responses must be at least 2 bytes");this.majorVersion=e[0],this.minorVersion=e[1]},h.Type4LibraryVersion.prototype.getMajorVersion=function(){return this.majorVersion},h.Type4LibraryVersion.prototype.getMinorVersion=function(){return this.minorVersion},h.Type4LibraryVersion.prototype.setMajorVersion=function(e){this.majorVersion=e},h.Type4LibraryVersion.prototype.setMinorVersion=function(e){this.minorVersion=e},h.Type4Error=function(){arguments.length<3?(this.errorCode=0,this.internalErrorCode=0,this.readerStatus=0,this.message=""):(this.errorCode=arguments[0],this.internalErrorCode=arguments[1],this.readerStatus=arguments[2],arguments.length>3?this.message=arguments[3]:this.message="")},h.Type4Error.isTypeOf=a(l.Type4Error),h.Type4Error.prototype=p(l.Type4Error),h.Type4Error.prototype.getPayload=function(){for(var e=unescape(encodeURIComponent(this.message)),t=[],r=0;r<e.length;r++)t.push(e.charCodeAt(r));var o=new Uint8Array(3+t.length);return o[0]=this.errorCode,o[1]=this.internalErrorCode,o[2]=this.readerStatus,o.set(t,3),o},h.Type4Error.prototype.parsePayload=function(e){if(e.length<3)throw new Error("Typer 4 error payload must be at least 3 bytes");this.errorCode=e[0],this.internalErrorCode=e[1],this.readerStatus=e[2],e.length>3?this.message=String.fromCharCode.apply(null,e.slice(3)):this.message=""},h.Type4Error.prototype.getErrorCode=function(){return this.errorCode},h.Type4Error.prototype.getInternalErrorCode=function(){return this.internalErrorCode},h.Type4Error.prototype.getReaderStatusCode=function(){return this.readerStatus},h.Type4Error.prototype.getErrorMessage=function(){return this.message},h.Type4Error.prototype.setErrorCode=function(e){this.errorCode=e},h.Type4Error.prototype.setInternalErrorCode=function(e){this.internalErrorCode=e},h.Type4Error.prototype.setReaderStatusCode=function(e){this.readerStatus=e},h.Type4Error.prototype.setErrorMessage=function(e){this.message=e};var T={TOO_FEW_PARAMTERS:1,TOO_MANY_PARAMETERS:2,TRANSCEIVE_ERROR:3,INVALID_PARAMETER:4,NO_TAG_PRESENT:5,NFC_CHIP_ERROR:6},m=function(n){if("object"!=typeof n||null===n)throw new Error("Command passed to resolver must be an object implementing: "+i.join(", "));if(!r(n,i))throw new Error("Error, command passed to resolver must also implement: "+t(n,i).join(", "));return!!o(n.getCommandFamily(),e)},g=function(){};return g.prototype.checkFamily=function(e){return m(e)},g.prototype.validate=function(e){if(m(e))return!0;throw new Error("Resolver doesn't support command's family")},g.prototype.resolveCommand=function(e){var t=null;if(this.validate(e))switch(e.getCommandCode()){case s.TransceiveApdu:t=new n.TransceiveApdu,t.parsePayload(e.getPayload());break;case s.DetectType4B:t=new n.DetectType4B,t.parsePayload(e.getPayload());break;case s.DetectType4BSpecificAfi:t=new n.DetectType4BSpecificAfi,t.parsePayload(e.getPayload());break;case s.DetectType4:t=new n.DetectType4,t.parsePayload(e.getPayload());break;case s.GetLibraryVersion:t=new n.GetLibraryVersion,t.parsePayload(e.getPayload())}return t},g.prototype.resolveResponse=function(e){var t=null;if(this.validate(e)){var r=null;switch(e.getCommandCode()){case l.ApduTransceiveSuccessful:r=h.ApduTransceiveSuccessful;break;case l.Type4BDetected:r=h.Type4BDetected;break;case l.Type4Detected:r=h.Type4Detected;break;case l.Type4LibraryVersion:r=h.Type4LibraryVersion;break;case l.Type4PollingError:r=h.Type4PollingError;break;case l.Type4Timeout:r=h.Type4Timeout;break;case l.Type4Error:r=h.Type4Error}null!==r&&(t=new r,t.parsePayload(e.getPayload()))}return t},{Commands:n,Responses:h,ErrorCodes:T,Resolver:g,FamilyCode:e}});